pipeline {
  agent any

  stages {
    stage('Unit Tests - Backend') {
      agent {
        docker {
          image 'snakee/golang-junit:1.21'
          reuseNode true
        }
      }
      environment {
        XDG_CACHE_HOME = "${WORKSPACE}/.gocache"
        GOCACHE        = "${WORKSPACE}/.gocache/go-build"
        GOMODCACHE     = "${WORKSPACE}/.gocache/mod"
      }
      steps {
        dir('bugtracker-backend') {
          sh '''
            set -eux
            mkdir -p "$XDG_CACHE_HOME" "$GOCACHE" "$GOMODCACHE"
            go env
            go test -v ./...
          '''
        }
      }
    }

    stage('Unit Test - Frontend') {
      agent {
        docker {
          image 'node:20-alpine'
          reuseNode true
        }
      }
      environment {
        CI = 'true'     // Jest не будет пытаться watch'ить
        TZ = 'UTC'      // стабильные снапшоты даты/времени
      }
      steps {
        dir('bugtracker-frontend') {
          sh '''
            set -eux
            npm ci
            # если в проекте есть скрипт test, этого достаточно.
            # чтобы избежать зависания в watch-режиме, CI=true уже задан.
            npm test -- --runInBand
          '''
        }
      }
      post {
        always {
          junit 'bugtracker-frontend/test-result.xml'
        }
      }
    }
  }
}
